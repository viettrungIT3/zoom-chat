<!DOCTYPE html>
<html>

<head>
    <title>Chat Rooms</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #chat-section {
            height: 100vh;
            display: none;
            flex-direction: column;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .message {
            margin: 5px 0;
        }

        .system-message {
            color: gray;
            font-style: italic;
        }

        .room-btn {
            cursor: pointer;
        }

        .chat-input {
            flex: 1;
            margin-right: 10px;
        }

        .user-message {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 70%;
            width: fit-content;
            word-wrap: break-word;
        }

        .user-message.right {
            background-color: #d1f7c4;
            margin-left: auto;
        }

        .user-message.left {
            background-color: #f0f0f0;
            margin-right: auto;
        }

        .user-message.system {
            text-align: center;
            font-style: italic;
        }
    </style>
</head>

<body class="bg-light">

    <div id="rooms-section" class="container my-5">
        <h2 class="text-center">Room List</h2>
        <div id="room-list" class="d-flex flex-wrap justify-content-center mt-4"></div>
    </div>

    <div id="chat-section" class="d-flex">
        <!-- Header -->
        <div class="d-flex align-items-center justify-content-between p-3 bg-primary text-white">
            <h3 id="current-room" class="m-0"></h3>
            <button class="btn btn-light btn-sm" onclick="leaveRoom()">Leave Room</button>
        </div>

        <!-- Chat Body -->
        <div id="messages" class="overflow-auto p-3"
            style="height: 400px; background-color: #f8f9fa; border-radius: 5px;">
            <!-- Messages will be added dynamically here -->
        </div>

        <!-- Footer -->
        <div class="d-flex p-3 bg-light border-top">
            <input id="messageInput" class="form-control chat-input" placeholder="Enter your message"
                onkeypress="handleKeyPress(event)">
            <button class="btn btn-primary" onclick="sendMessage()">
                <i class="bi bi-send-fill"></i> Send
            </button>
        </div>
    </div>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        if (currentRoom) {
            document.getElementById('rooms-section').style.display = 'none';
            document.getElementById('chat-section').classList.add('d-flex');
        } else {
            document.getElementById('rooms-section').style.display = 'block';
            document.getElementById('chat-section').classList.remove('d-flex');
        }

        // Update room list
        socket.on('room-list-update', (rooms) => {
            const roomList = document.getElementById('room-list');
            roomList.innerHTML = '';
            rooms.forEach(room => {
                const roomBtn = document.createElement('button');
                roomBtn.className = 'btn btn-outline-primary m-2 room-btn';
                roomBtn.textContent = `${room.name} (${room.memberCount} members)`;
                roomBtn.onclick = () => joinRoom(room.name);
                roomList.appendChild(roomBtn);
            });
        });

        function joinRoom(roomName) {
            fetch(`/messages/${roomName}`)
                .then(response => response.json())
                .then(messages => {
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = '';
                    messages.forEach(msg => {
                        displayMessage(msg.userId || 'System', msg.message, msg.type);
                    });
                    scrollToBottom();
                });

            socket.emit('join-room', roomName);
            currentRoom = roomName;

            document.getElementById('rooms-section').style.display = 'none';
            document.getElementById('chat-section').classList.add('d-flex');
            document.getElementById('current-room').textContent = roomName;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;
            if (message && currentRoom) {
                socket.emit('send-message', { room: currentRoom, message });
                displayMessage('You', message);
                messageInput.value = '';
                scrollToBottom();
            }
        }

        function leaveRoom() {
            if (currentRoom) {
                socket.emit('leave-room', currentRoom);
                currentRoom = null;

                document.getElementById('rooms-section').style.display = 'block';
                document.getElementById('chat-section').classList.remove('d-flex');

                document.getElementById('messages').innerHTML = '';
            }
        }


        function displayMessage(sender, message, type = 'user') {
            const messageContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('user-message', 'my-2', 'p-2'); // Bootstrap classes

            if (type === 'system') {
                messageElement.classList.add('system', 'text-center', 'mx-auto');
                messageElement.innerHTML = `<em>${message}</em>`;
            } else if (sender === 'You') {
                messageElement.classList.add('right', 'text-end');
                messageElement.innerHTML = `${message}`;
            } else {
                messageElement.classList.add('left', 'text-start');
                messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            }

            messageContainer.appendChild(messageElement);

            // Auto scroll to the newest message
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }



        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        socket.on('user-joined', (data) => {
            displayMessage('System', data.message, 'system');
        });

        socket.on('user-left', (data) => {
            displayMessage('System', data.message, 'system');
        });

        socket.on('receive-message', (data) => {
            const sender = data.userId === socket.id ? 'You' : data.userId;
            displayMessage(sender, data.message);
        });


    </script>
</body>

</html>